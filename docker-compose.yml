services:
  mc:
    image: itzg/minecraft-server:java17
    container_name: mc
    # mc がネットワーク名前空間の所有者
    # tailscale が落ちても mc のネットワークは影響を受けない
    ports:
      - "${MC_PORT:-25565}:25565"
    environment:
      EULA: "TRUE"
      TYPE: FORGE
      VERSION: "1.20.1"
      FORGE_VERSION: "47.4.10"
      # Modpack (GENERIC_PACK: PrismLauncher .zip から変換済み)
      GENERIC_PACK: /modpacks/server-pack.tar.gz
      # メモリ: .env の MC_MEMORY で制御
      MEMORY: "${MC_MEMORY:-4G}"
      # サーバー設定
      MAX_TICK_TIME: "-1"
      TZ: "Asia/Tokyo"
      # G1GCチューニング
      JVM_XX_OPTS: >-
        -XX:+UseG1GC
        -XX:+ParallelRefProcEnabled
        -XX:MaxGCPauseMillis=200
        -XX:+UnlockExperimentalVMOptions
        -XX:+DisableExplicitGC
        -XX:+AlwaysPreTouch
        -XX:G1NewSizePercent=30
        -XX:G1MaxNewSizePercent=40
        -XX:G1HeapRegionSize=8M
        -XX:G1ReservePercent=20
        -XX:G1HeapWastePercent=5
        -XX:G1MixedGCCountTarget=4
        -XX:InitiatingHeapOccupancyPercent=15
        -XX:G1MixedGCLiveThresholdPercent=90
        -XX:G1RSetUpdatingPauseTimePercent=5
        -XX:SurvivorRatio=32
        -XX:+PerfDisableSharedMem
        -XX:MaxTenuringThreshold=1
      # Forgeのログインタイムアウト延長（デフォルト30秒→120秒）
      JVM_DD_OPTS: "fml.readTimeout=120 fml.loginTimeout=120"
      # RCON
      ENABLE_RCON: "true"
      RCON_PASSWORD: "${RCON_PASSWORD:-changeme}"
    volumes:
      - mc-data:/data
      - ./modpacks:/modpacks:ro
    tty: true
    stdin_open: true
    restart: unless-stopped
    labels:
      autoheal: "true"
    healthcheck:
      test: mc-health
      start_period: 5m
      interval: 30s
      retries: 6

  # ============================================================
  # Tailscale サイドカー
  # mc のネットワーク名前空間に相乗りし、
  # Tailscale IP でのアクセスを提供する。
  # mc が先に起動し、tailscale はその後に参加する。
  # tailscale が落ちても mc は影響を受けない。
  # TS_AUTHKEY が未設定の場合は tailnet に参加しない（通常動作に影響なし）。
  # ============================================================
  tailscale-mc:
    image: tailscale/tailscale:latest
    container_name: mc-tailscale
    # mc のネットワーク名前空間に相乗り
    # (network_mode: service:* では hostname: を設定できないため、
    #  Tailscale のデバイス名は TS_EXTRA_ARGS --hostname で指定)
    network_mode: service:mc
    depends_on:
      mc:
        condition: service_started
    environment:
      TS_AUTHKEY: "${TS_AUTHKEY:-}"
      TS_STATE_DIR: /var/lib/tailscale
      TS_EXTRA_ARGS: "${TS_EXTRA_ARGS:---advertise-tags=tag:mc-server --hostname=${TS_HOSTNAME:-mc-server}}"
    volumes:
      - ts-state:/var/lib/tailscale
    restart: unless-stopped

  restore-backup:
    image: itzg/mc-backup
    restart: "no"
    entrypoint: restore-tar-backup
    volumes:
      - mc-data:/data
      - mc-backups:/backups:ro

  backups:
    image: itzg/mc-backup
    container_name: mc-backups
    depends_on:
      mc:
        condition: service_healthy
    environment:
      BACKUP_INTERVAL: "6h"
      RCON_HOST: mc
      RCON_PASSWORD: "${RCON_PASSWORD:-changeme}"
      INITIAL_DELAY: "0"
      BACKUP_METHOD: tar
      TAR_COMPRESS_METHOD: zstd
      PRUNE_BACKUPS_DAYS: "7"
      PRUNE_BACKUPS_COUNT: "5"
    volumes:
      - mc-data:/data:ro
      - mc-backups:/backups

  scheduler:
    image: alpine:latest
    container_name: mc-scheduler
    depends_on:
      mc:
        condition: service_healthy
    environment:
      RCON_HOST: mc
      RCON_PORT: "25575"
      RCON_PASSWORD: "${RCON_PASSWORD:-changeme}"
      TZ: "Asia/Tokyo"
    env_file:
      - schedule.env
    volumes:
      - mc-data:/data
      - ./scripts/scheduler:/scripts:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    entrypoint: /scripts/scheduler-entrypoint.sh
    restart: unless-stopped

  autoheal:
    image: willfarrell/autoheal
    container_name: mc-autoheal
    restart: unless-stopped
    environment:
      AUTOHEAL_CONTAINER_LABEL: autoheal
      AUTOHEAL_INTERVAL: "60"
      AUTOHEAL_DEFAULT_STOP_TIMEOUT: "30"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # ============================================================
  # MinedMap - 軽量2D Webマップ
  # Rust製の外部レンダラー。region ファイルを直接読み取り、
  # Leaflet タイルを生成する。mod/plugin 不要。
  # --watch モードでファイル変更を検知し自動で増分レンダリング。
  # ============================================================
  minedmap:
    image: ghcr.io/neocturne/minedmap/minedmap
    container_name: mc-minedmap
    depends_on:
      mc:
        condition: service_healthy
    command:
      - "--jobs-initial=${MAP_JOBS_INITIAL:-2}"
      - "--jobs=${MAP_JOBS:-1}"
      - "--image-format=webp"
      - "--sign-prefix=${MAP_SIGN_PREFIX:-[Map]}"
      - "--sign-transform=s/\\[Map\\]//"
      - "--watch"
      - "--watch-delay=${MAP_WATCH_DELAY:-3600}"
      - "/input/${MAP_WORLD_NAME:-world}"
      - "/output"
    volumes:
      - mc-data:/input:ro
      - map-tiles:/output
      - map-processed:/output/processed
    network_mode: "none"
    restart: unless-stopped

  map-viewer:
    image: ghcr.io/neocturne/minedmap/viewer
    container_name: mc-map-viewer
    ports:
      - "${MAP_PORT:-8123}:80"
    volumes:
      - map-tiles:/usr/share/nginx/html/data:ro
    restart: unless-stopped

volumes:
  mc-data:
  mc-backups:
  ts-state:
  map-tiles:
  map-processed:
